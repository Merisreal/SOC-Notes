## Kerberos

https://www.tarlogic.com/blog/how-kerberos-works/
https://www.tarlogic.com/cybersecurity-glossary/krbtgt/


Kerberos là giao thức xác thực Authentication  - không phải phân quyền Authorization
+ Nó cho phép nhận dạng mỗi user, những user cung cấp secret password
+ Nhưng không xác thực những tài nguyên hoặc dịch vụ > nào người dùng có thể truy cập 
=> Kerberos chỉ xác minh "bạn là ai" chứ ko xác định "bạn được làm gì trong mạng", mà việc xác định họ có thể làm gì được xử lý bởi các hệ thống, ứng dụng riêng biệt sau khi user đã được xác thực

+ Hoạt động ở TRANSPORT LAYER
	+ **TCP/88 và UDP/88**
### Agents
+ Client, user: người muốn truy cập vào service
+ AP (Application Server): cung cấp service theo yêu cầu người dùng
+ KDC (Key distribution Center): Service chính của Kerberos, phân phối tickets, được cài đặt trên DC (Domain Controller),  được hỗ trợ bởi AS (Authentication Service) -> Nơi phân phối TGTs
### Encryption Keys

+ KDC or krbtgt key: từ hàm băm NTLM của tài khoản krbtgt
+ KRBTGT: Tài khoản mặc định tồn tại trong tất cả các domain của Active Directory -> hoạt động như một KDC cho các domain controller
		+) Khi một user muốn xác thực qua Kerberos, phải có TGT ticket trước và được ký bởi khóa lấy từ mật khẩu của KRBTGT account -> nếu bị lộ dẫn đến attacker có thể lấy làm Golden Tickets
+ User Key: từ hàm băm NTLM của user
+ Service Key: từ hàm băm NTKM của service owner,  có thể là tài khoản user hoặc máy tính
+ Session key: Được "đàm phán" giữa user và KDC
+ Service Session Key: được dùng giữa user và service

### Tickets
Có 2 tickets chính, được phân phối tới user để sử dụng tỏng môi trường Kerberos

+ TGS (Ticket Granting Service): ticket mà user có thể sử dụng để xác thực đối với service, được mã hóa với service key
+ TGT (Ticket Granting Ticket): Ticket được xuất trình cho KDC để yêu cầu TGS, được mã hóa với KDC key

### Messages

- **KRB_AS_REQ**: Được sử dụng để yêu cầu TGT từ KDC.
- **KRB_AS_REP**: Được sử dụng để KDC cấp phát TGT.
- **KRB_TGS_REQ**: Được sử dụng để yêu cầu TGS từ KDC, sử dụng TGT.
- **KRB_TGS_REP**: Được sử dụng để KDC cấp phát TGS.
- **KRB_AP_REQ**: Được sử dụng để xác thực một user với một service, sử dụng TGS.
- **KRB_AP_REP**: (Tùy chọn) Được service sử dụng để nhận diện chính nó với user.
- **KRB_ERROR**: Thông điệp dùng để truyền đạt các điều kiện lỗi.

![Pasted image 20240925153426](https://github.com/user-attachments/assets/37e88878-fdcf-4466-869f-17b7b24d2c6d)

### Authentication Process

#### KRB_AS_REQ
đầu tiên để có được TGT từ KDC, KRB_AS_REQ phải được gửi trước
![[Pasted image 20240925155503.png]]
![Pasted image 20240925155503](https://github.com/user-attachments/assets/24f9c90c-a4ef-48dc-a54c-dbdd1e8ddff2)

+ Timestamp: tránh replay attack
+ Username: tên người dùng được xác thựuc
+ Service SPN có liên quan tới krbtgt account
+ User nonce
#### KRB_AS_REP
sau khi nhận được request, KDC xác thực danh tính user -> decryp timestamp, nếu message đúng -> KRB_AS_REP
![[Pasted image 20240925155735.png]]
![Pasted image 20240925155735](https://github.com/user-attachments/assets/2c2c5f82-eb1c-438f-9c82-58e074e89875)


- **Username**
- **TGT**
    - **Username**
    - **Session key**
    - **Expiration date** of TGT
    - **PAC** : Đặc quyền người dùng, ký bởi KDC
- Some **encrypted data** with user key, which includes:
    - **Session key**
    - **Expiration date** of TGT
    - User **nonce**, to prevent replay attacks
=> Khi có TGT có thể dùng để request TGSs

#### KRB_TGS_REQ

![[Pasted image 20240925155900.png]]
![Pasted image 20240925155900](https://github.com/user-attachments/assets/389cebb9-1578-4cba-b34b-03bb96b83118)


_KRB_TGS_REQ_ includes:

- **Encrypted data** with session key:
    - **Username**
    - **Timestamp**
- **TGT**
- **SPN** of requested service
- **Nonce** generated by use


#### KRB_TGS_REP

![[Pasted image 20240925155923.png]]
![Pasted image 20240925155923](https://github.com/user-attachments/assets/dd9d8c60-8536-49d3-8bcf-5e15f705d5fe)


_KRB_TGS_REP_ includes:

- **Username**
- **TGS**, which contains:
    - **Service session key**
    - **Username**
    - **Expiration date** of TGS
    - **PAC** with user privileges, signed by KDC
- **Encrypted data** with session key:
    - **Service session key**
    - **Expiration date** of TGS
    - User **nonce**, to prevent replay attacks

#### KRB_AP_REQ

Để kết thúc, user đã có TGS hợp lệ để tương tác với service, user phải gửi KRP-AP-REQ 
![Pasted image 20240925160039](https://github.com/user-attachments/assets/c1c39253-f6f5-43d1-be38-25d3972daa7a)

![[Pasted image 20240925160039.png]]
_KRB_AP_REQ_ includes:

- **TGS**
- **Encrypted data** with service session key:
    - **Username**
    - **Timestamp**, to avoid replay attacks

## Kerberos Pre-Authentication
Cơ chế bảo mật của Kerberos bảo vệ thông tin xác thực của người dùng trong quá trình xác thực. 
Khi user truy cập vào tài nguyên network, client sẽ gửi authen request AS-REQ tới KDC
Nếu Pre-Authentication được bật, request này sẽ chứa dấu thời gian được mã hóa (pA-ENC-TIMESTAMP)
KDC cố gắng giải mã dấu thời gian này bằng cách sử dụng hàm băm mật khẩu người dùng và nếu thành công sẽ cấp TGT cho người dùng.
![Pasted image 20240919170117](https://github.com/user-attachments/assets/3f7722fd-536f-4033-9c49-86b4f10ddb70)

Còn khi không có Pre-Authentication -> cho phép người dùng request TGT mà ko cần biết password người dùng
![Pasted image 20240919170152](https://github.com/user-attachments/assets/60718475-663f-445a-ad27-dcd3e7c5a2fe)

